# 테이블 연결성 분석 및 병합 도구 (opendataloader 버전)

PDF 문서에서 여러 페이지에 걸쳐 이어지는 테이블들을 자동으로 찾아서 병합하고 원본 PDF에 오버레이하는 도구입니다.

**이 버전은 opendataloader-pdf를 사용합니다.**

## 주요 기능

- ✅ **텍스트 연결성 분석**: 테이블 간 텍스트가 자연스럽게 이어지는지 감지
- ✅ **헤더 비교**: 동일한 헤더를 가진 테이블 자동 병합
- ✅ **타이틀 기반 분리**: 서로 다른 타이틀을 가진 테이블은 별도로 처리
- ✅ **헤더+데이터 구조 인식**: 헤더가 있는 테이블과 데이터만 있는 테이블 연결
- ✅ **원본 PDF 오버레이**: 연결된 테이블을 원본 PDF 위에 색깔별로 표시 (docling 버전과 동일)
- ✅ **멀티 로우 헤더 처리**: 여러 행에 걸친 헤더 자동 인식
- ✅ **30% 키값 중복 체크**: 반복 테이블 자동 분리
- ✅ **상세 설명 PDF**: 범례 및 연결 이유 포함

## 설치

```bash
pip install opendataloader-pdf PyPDF2 reportlab
```

**요구사항:**
- Python 3.9+
- Java 11+ (opendataloader-pdf 필요)

## 사용 방법

### 전체 파이프라인 실행 (추천)

```bash
# input 폴더의 모든 PDF 처리
python run_all.py

# 특정 PDF 파일만 처리
python run_all.py --pdf "../input/파일.pdf"
```

### 단계별 실행

```bash
# 1단계: 테이블 추출 및 병합
python merge_connected_tables.py

# 2단계: 원본 PDF에 연결된 테이블 오버레이
python visualize_connected_tables.py
```

**출력 결과:**
- `merged_tables_output/*_merged.json`: 각 파일별 병합 결과
- `visualized_pdfs/*_connected_tables.pdf`: 원본 PDF + 색상 오버레이
- `visualized_pdfs/연결된_테이블_설명.pdf`: 상세 설명

## 테이블 병합 규칙

### 📋 연결 규칙 (우선순위 순)

#### 1. 타이틀 기반 분리 (최우선)
**둘 다 타이틀이 있는 경우:**
- ✅ **완전 일치** → 같은 테이블 (유사도 1.0)
- ✅ **포함 관계** → 같은 테이블 (유사도 0.8)
  - 예: "표 3.1 제목" ⊆ "표 3.1 제목 (계속)"
- ❌ **그 외 모든 경우** → 다른 테이블 (유사도 0.0)
  - 예: "표 3.1 제목" ≠ "표 3.2 제목"
  - 예: "4. 시험장 위치(1군)" ≠ "5. 시험장 위치(2군)"

**같은 페이지 + 타이틀 다름:**
- 유사도 80% 미만이면 무조건 분리
- 예: 같은 페이지에 있는 "표 5.4" 와 "표 5.5"

**두 번째 테이블에만 타이틀:**
- 새로운 섹션 시작으로 간주하여 분리
- 헤더가 같아도 분리

#### 2. 텍스트 연결성 🔗
**감지 방법:**
- 첫 번째 테이블의 마지막 5개 셀 vs 두 번째 테이블의 첫 5개 셀 비교
- 텍스트가 이어지는 패턴 확인

**연결 패턴:**
- **숫자 순서**: `1)` → `2)`, `가.` → `나.`, `①` → `②`
- **한글 순서**: `가.` → `나.`, `ㄱ.` → `ㄴ.`
- **단어 잘림**: "국가재난관리" → "국가재난관리시스템" (최소 5자 이상)
- **불완전한 문장**: "~의", "~를", "~및", "~와" 등으로 끝나는 경우

**예시:**
```
테이블 1 끝: "재난관리 기본법에 따라"
테이블 2 시작: "기본법에 따라 다음과 같이"
→ 연결됨 (단어 잘림)
```

#### 3. 헤더 동일 📋
**조건:**
- 두 테이블 모두 헤더 있음
- 헤더 개수 각각 최소 2개 이상
- 공통 헤더 최소 2개 이상
- 유사도 60% 이상

**검증:**
- 키값(첫 번째 열) 중복 체크
- 30% 이상 중복시 다른 테이블로 판단

**예시:**
```
테이블 1: [구분, 항목, 내용, 비고]
테이블 2: [구분, 항목, 내용, 비고]
→ 연결됨 (4개 일치, 100%)
```

#### 4. 헤더 + 데이터 구조 📊
**조건:**
- 첫 번째 테이블: 헤더 있음
- 두 번째 테이블: 헤더 없음 (데이터만)
- 연속 페이지 (1페이지 차이)

**타이틀이 있는 경우:**
- 첫 번째 테이블에 타이틀 있고 연속 페이지면 연결

**텍스트 연결이 있는 경우:**
- 연결성 감지시 연결

#### 5. 타이틀 있는 데이터 테이블 연속
**조건:**
- 첫 번째: 타이틀 있음, 헤더 없음
- 두 번째: 타이틀 없음, 헤더 없음
- 열 개수 정확히 동일
- 연속 페이지 (1페이지 차이)

**예시:**
```
테이블 1: 타이틀="표 5.9 결과", 헤더 없음, 3열
테이블 2: 타이틀 없음, 헤더 없음, 3열
→ 연결됨
```

#### 6. 헤더 없는 데이터 테이블 연속
**조건:**
- 둘 다 타이틀 없음, 헤더 없음
- 연속 페이지 (1페이지 차이)
- 열 개수 차이 1개 이하
- 최소 2열 이상

**키값 중복 체크:**
- 첫 번째 열 데이터 비교
- 50% 이상 중복시 반복 테이블로 간주하여 분리
  - 예: 요구사항 템플릿이 반복되는 경우

### ❌ 분리 규칙

#### 필수 분리 조건:
1. **페이지 차이**: 2페이지 이상 떨어진 경우
2. **타이틀 불일치**:
   - 둘 다 타이틀 있고 포함 관계가 아닌 경우
   - 같은 페이지 + 타이틀 유사도 80% 미만
3. **새로운 타이틀**: 두 번째 테이블에만 타이틀이 있는 경우
4. **키값 중복**: 헤더는 같지만 데이터 행이 30% 이상 중복
5. **반복 테이블**: 헤더 없는 테이블의 키값이 50% 이상 중복

#### 특수 분리:
- **페이지 헤더 필터링**: "제X장", "숫자 │ 제목" 패턴은 타이틀에서 제외
- **페이지 번호 필터링**: 순수 숫자나 3자 미만 텍스트는 타이틀에서 제외

## 타이틀 추출 방법

### 추출 위치
- 테이블 상단 300px 이내의 텍스트 검색
- 거리가 가까운 순서대로 우선순위

### 타이틀 필터링
**제외되는 텍스트:**
1. 숫자만 있는 경우 (페이지 번호)
2. 3자 미만의 짧은 텍스트
3. 페이지 헤더 패턴:
   - "제X장"으로 시작하는 경우
   - "숫자 │ 텍스트" 패턴 (예: "88 │ 재난원인조사...")
4. 다른 테이블 내부의 텍스트 (50px 초과 거리일 때만)

### 멀티 로우 헤더 처리
- 같은 열에 여러 행에 걸친 헤더가 있는 경우
- 각 열에서 가장 긴(구체적인) 텍스트를 헤더로 선택
- 헤더가 1개만 있으면 헤더가 아닌 것으로 간주

## 처리 순서

```
1. opendataloader로 PDF 파싱
   └─ JSON 형식으로 테이블 추출

2. 테이블 정보 추출
   ├─ 타이틀 추출 (상단 300px 이내)
   ├─ 멀티 로우 헤더 추출
   ├─ 키값 추출 (첫 번째 열 데이터)
   └─ 텍스트 추출 (연결성 분석용)

3. 페이지 순서대로 정렬

4. 연결성 체크 (순차적으로)
   ├─ 페이지 차이 확인 (0-2 페이지)
   ├─ 구조 유사성 확인
   ├─ 타이틀 비교 (최우선)
   ├─ 텍스트 연결 확인
   ├─ 헤더 비교 (30% 키값 중복 체크 포함)
   └─ 특수 패턴 확인 (헤더+데이터 등)

5. 그룹핑
   ├─ 연결된 테이블들을 그룹으로 묶기
   ├─ 단일 테이블 별도 관리
   └─ 비연속 이유 저장

6. 출력
   ├─ 병합 결과 JSON 저장
   └─ 원본 PDF에 오버레이 (색상별 그룹 표시)
```

## 디렉토리 구조

```
표_연속성체크_04/
├── opendataloader_version/        # 이 폴더
│   ├── merge_connected_tables.py  # 병합 스크립트 (메인)
│   ├── visualize_connected_tables.py # 시각화 스크립트
│   ├── run_all.py                 # 전체 파이프라인
│   ├── README.md                  # 이 파일
│   ├── merged_tables_output/      # 병합 결과 JSON
│   ├── visualized_pdfs/           # 오버레이 PDF
│   ├── table_output/              # opendataloader 임시 JSON
│   └── output/                    # (예비)
│
└── input/                          # 원본 PDF 파일 (공유)
```

## 출력 예시

### 병합 결과 (콘솔)
```
처리 중: 삼성물산.pdf
  총 테이블 수: 23
  병합된 그룹 수: 15

  그룹 3:
    테이블 인덱스: [3, 4, 5]
    페이지: [3, 4, 5]
    ✓ Table 3 + Table 4: 헤더+데이터 패턴
    ✓ Table 4 + Table 5: 데이터+데이터 패턴 (같은 타이틀)
```

### 오버레이 PDF
- 같은 색상 = 연결된 테이블 그룹
- 각 박스에 타이틀, 그룹 번호, 연결/비연속 이유 표시
- 원본 내용 유지 (투명도 15% 오버레이)
- 병합된 테이블: 색칠 + 굵은 테두리
- 단일 테이블: 회색 테두리만

**색상 팔레트 (20가지):**
빨강, 청록, 파랑, 연어색, 민트, 노랑, 보라, 하늘색, 주황, 초록,
분홍, 밝은 파랑, 에메랄드, 오렌지, 자주, 청록2, 빨강2, 파랑2, 초록2, 주황2

## docling 버전과의 차이

| 항목 | docling 버전 | opendataloader 버전 |
|------|-------------|-------------------|
| PDF 파싱 | docling (DocLayNet 형식) | opendataloader-pdf |
| GPU 가속 | 지원 (3-6배 빠름) | 미지원 |
| 설치 | 복잡 (GPU 설정 필요) | 간편 (Java만 필요) |
| 병합 로직 | ✅ | ✅ (완전 동일) |
| 원본 PDF 오버레이 | ✅ | ✅ (동일 디자인) |
| 멀티 로우 헤더 | ✅ | ✅ |
| 텍스트 연결성 | ✅ | ✅ |
| 30% 키값 중복 | ✅ | ✅ |
| 폴더 구조 | 동일 | 동일 |
| 파일명 | 동일 | 동일 |

**선택 가이드:**
- **docling 버전**: GPU 있고 대량 처리 필요한 경우
- **opendataloader 버전**: 간편한 설치, 적은 수의 PDF 처리

## 참고

- 이 도구는 opendataloader-pdf로 추출한 테이블 데이터를 사용합니다
- 한글 폰트는 Windows의 `malgun.ttf`를 사용합니다
- Java 11 이상이 필요합니다 (`java -version`으로 확인)
- 테이블 병합은 순차적으로만 진행되며 건너뛰기는 불가능합니다
- opendataloader의 bbox 좌표계는 bottom-left origin을 사용합니다
